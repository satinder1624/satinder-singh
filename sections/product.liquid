<section class="homeProductCollection">
  <div class="container">
    <div class="productGrid">
      {% assign collection = collections.frontPage %}
      {% if collection.products.size > 0 %}
        {% for product in collection.products %}
          <div class="productItem">
            <div class="productImageWrapper">
              <img
                class="mobileImage"
                src="{{ product.featured_image | img_url: '500x500' }}"
                alt="{{ product.title }}"
                width=""
                height=""
              >
              <div
                class="plusOverlay"
                data-product-id="{{ forloop.index }}"
                style="
                  {% if forloop.index == 1 %}
                      top: 205px; right: 192px;
                  {% elsif forloop.index == 2 %}
                      top: 150px; right: 140px;
                  {% elsif forloop.index == 3 %}
                      top: 90px; right: 200px;
                  {% elsif forloop.index == 4 %}
                      top: 80px; right: 170px;
                  {% elsif forloop.index == 5 %}
                      top: 80px; right: 230px;
                  {%else%}
                      top: 100px; right: 170px;
                  {% endif %}
                "
              >
                <span class="plusIcon">+</span>
              </div>
            </div>
          </div>
          <dialog class="productModal" id="modal-{{ forloop.index }}">
            <div class="modalContent">
              <span class="closeModal" data-product-id="{{ forloop.index }}">
                <img src="{{ 'cross.png' | asset_url }}" alt="Banner">
              </span>
              <div class="productInfoContainer">
                <div class="productImg">
                  <img
                    src="{{ product.featured_image | img_url: '280x280' }}"
                    alt="{{ product.title }}"
                  >
                </div>
                <div class="productDetails">
                  <span class="productTitle">{{ product.title }}</span>
                  <span class="productPrice">{{ product.price | money_with_currency }}</span>
                  <span class="productDescription">{{ product.description | strip_html | truncate: 100 }}</span>
                </div>
              </div>

              {% comment %} Color selection {% endcomment %}
              <div class="colorWrapper">
                <span class="colorLabel">Color</span>
                <div class="colorContainer">
                  {% assign available_colors = '' %}
                  {% for variant in product.variants %}
                    {% unless available_colors contains variant.option2 %}
                      {% assign available_colors = available_colors | append: variant.option2 | append: ',' %}
                    {% endunless %}
                  {% endfor %}
                  {% assign color_list = available_colors | split: ',' %}
                  {% for color in color_list %}
                    {% if color != '' %}
                      <div
                        class="colorBox"
                        data-variant-id="{% for variant in product.variants %}{% if variant.option2 == color %}{{ variant.id }}{% endif %}{% endfor %}"
                        style="background-color: {{ color }}"
                      ></div>
                      <span>{{ color }}</span>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>

              {% comment %} Size selection {% endcomment %}
              <div class="dropdown">
                <div class="dropdownContent">
                  <div class="dropdownLabel">Select Size</div>
                  <div class="dropdownArrow"></div>
                </div>
                <div class="dropdownOptions">
                  {% assign available_sizes = '' %}
                  {% for variant in product.variants %}
                    {% unless available_sizes contains variant.option1 %}
                      {% assign available_sizes = available_sizes | append: variant.option1 | append: ',' %}
                    {% endunless %}
                  {% endfor %}
                  {% assign size_list = available_sizes | split: ',' %}
                  {% for size in size_list %}
                    {% if size != '' %}
                      <div
                        class="option"
                        data-variant-id="{% for variant in product.variants %}{% if variant.option1 == size %}{{ variant.id }}{% endif %}{% endfor %}"
                      >
                        {{ size }}
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>

              <form method="post" action="/cart/add.js" class="addToCartForm">
                <input type="hidden" name="id" value="" id="variantId-{{ forloop.index }}">
                <button type="submit" class="addToCartButton">
                  Add to cart
                  <img
                    class="leftWhiteArrow"
                    src="{{ 'leftWhiteArrow.png' | asset_url }}"
                  >
                </button>
              </form>
            </div>
          </dialog>
        {% endfor %}
      {% else %}
        <p>No products available!</p>
      {% endif %}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    let selectedColorId = null;
    let selectedSizeId = null;

    document.querySelectorAll('.colorBox').forEach(function (box) {
      box.addEventListener('click', function () {
        document.querySelectorAll('.colorBox').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        selectedColorId = this.getAttribute('data-variant-id');

        if (selectedColorId && selectedSizeId) {
          const form = this.closest('.productModal').querySelector('.addToCartForm');
          form.querySelector('input[name="id"]').value = selectedColorId;
        }
      });
    });

    document.querySelectorAll('.dropdown').forEach(function (dropdown) {
      dropdown.addEventListener('click', function () {
        this.classList.toggle('active');
      });
    });

    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('option')) {
        const option = event.target;
        const dropdown = option.closest('.dropdown');
        const label = dropdown.querySelector('.dropdownLabel');
        label.textContent = option.textContent;
        dropdown.classList.remove('active');
        selectedSizeId = option.getAttribute('data-variant-id');

        if (selectedColorId && selectedSizeId) {
          const form = option.closest('.productModal').querySelector('.addToCartForm');
          form.querySelector('input[name="id"]').value = selectedColorId;
        }
      }
    });

    function findMatchingVariant(colorId, sizeId) {
      return colorId;
    }

    document.querySelectorAll('.addToCartForm').forEach(function (form) {
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(this);

        fetch('/cart/add.js', {
          method: 'POST',
          body: formData,
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        })
          .then(response => response.json())
          .then(data => console.log('Product added to cart:', data))
          .catch(error => console.error('Error:', error));
      });
    });

    document.querySelectorAll('.plusOverlay').forEach(function (overlay) {
      overlay.addEventListener('click', function () {
        let productId = this.getAttribute('data-product-id');
        let modal = document.getElementById('modal-' + productId);
        modal.showModal();
      });
    });

    document.querySelectorAll('.closeModal').forEach(function (button) {
      button.addEventListener('click', function () {
        let productId = this.getAttribute('data-product-id');
        let modal = document.getElementById('modal-' + productId);
        modal.close();
      });
    });

    window.addEventListener('click', function (event) {
      let modals = document.querySelectorAll('.productModal');
      modals.forEach(function (modal) {
        if (event.target.tagName === 'DIALOG' && event.target.hasAttribute('open')) {
          modal.close();
        }
      });
    });
  });
</script>
